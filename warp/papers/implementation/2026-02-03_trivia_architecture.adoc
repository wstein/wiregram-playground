= Trivia-Based Token Architecture
:toc:
:toclevels: 3

== Overview
Warp now supports trivia-aware tokens for Ruby and Crystal lexers. Trivia captures non-semantic source text (whitespace and comments) and attaches it to tokens as a single leading trivia array instead of emitting standalone whitespace tokens.

== Rationale
* Fewer tokens: reduces memory pressure and improves cache locality.
* Cleaner parsing: parsers can skip trivia while still preserving formatting.
* Round-trip formatting: whitespace is preserved explicitly via trivia.

== Data Model

[source,crystal]
----
struct Trivia
  property kind : TriviaKind
  property start : Int32
  property length : Int32
end

struct Token
  property kind : TokenKind
  property start : Int32
  property length : Int32
  property trivia : Array(Trivia)
end
----

== Lexer Behavior
* Whitespace and comments are collected as trivia.
* Newlines remain tokens (for grammar-sensitive parsing).
* Trivia is attached to the next token (including newline and EOF).

== Parser & CST Impact
* Parsers ignore trivia in token streams.
* CST builders attach trivia to nodes for lossless reconstruction.
* Formatter uses trivia slices to preserve exact whitespace.

== Debugging & CLI
Token dumps include the trivia array when available so whitespace and comments are visible in diagnostics.
