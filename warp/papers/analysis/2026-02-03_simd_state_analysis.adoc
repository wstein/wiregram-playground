= SIMD State Analysis and Roadmap
:doctype: book
:author: Warp Engineering
:revnumber: 0.1
:revdate: 2026-02-03

== Executive Summary

This document summarizes the current SIMD coverage across Warp parsers (JSON, Ruby, Crystal), identifies architectural gaps, and provides a short, prioritized roadmap to achieve consistent SIMD support and related parser improvements.

*Key finding*: JSON retains the most mature SIMD pipeline. Ruby and Crystal now include SIMD structural scanners, state-aware helpers, and SIMD-integrated lexers, narrowing the performance gap while keeping backend parity (NEON, AVX2, AVX512, SSE2, Scalar).

== Current State

=== JSON
* Status: âœ… Fully implemented
* Backends: NEON, AVX2, AVX512, SSE2, Scalar
* Strengths: high performance, multi-backend support, integrated pipeline
* Gaps: limited to structural detection, no state-aware SIMD yet

=== Ruby
* Status: âœ… SIMD structural scan + state-aware helpers integrated
* Impact: improved lexing throughput on representative corpora; SIMD indices are consumed by lexer state machine

=== Crystal
* Status: âœ… SIMD structural scan + state-aware helpers integrated
* Impact: faster lexing on macro/annotation-heavy inputs with backend selection support

== Architecture Gaps

- SIMD alignment configuration needs explicit documentation and tests across backends
- Some language-specific pattern detection still relies on scalar fallbacks
- Benchmarks should capture end-to-end scan/lex speedups and backend variability

== Short Roadmap (Phases)

=== Phase 1 â€” Foundations (0â€“2 weeks)
* âœ… Create a common SIMD scanner interface (`src/warp/lang/common/simd_scanner.cr`).
* âœ… Scaffold Ruby and Crystal SIMD scanner implementations (language-specific masks).
* âœ… Add unit tests for Ruby/Crystal SIMD scanners (empty input, UTF-8 handling, basic structural detection).

=== Phase 2 â€” Integration (2â€“6 weeks)
* âœ… Integrate SIMD indices into Ruby/Crystal lexers and token scanners.
* âœ… Add benchmarks to measure SIMD speedups vs scalar on representative files.
* âœ… Add backend selection support and ensure ARMv6/NEON and x86 backends are selectable.

=== Phase 3 â€” Optimizations & State (6â€“12 weeks)
* âœ… Introduce state-aware SIMD helpers for string, heredoc, regex, macro scans.
* ðŸ”œ Optimize masks and backend implementations for key hotspots.
* ðŸ”œ Add performance regression tests and CI benchmarking harness.

=== Phase 4 â€” Long-term (12+ weeks)
* Refactor lexers to a stateful architecture (enable incremental parsing later).
* Explore cross-language SIMD utilities (dedupe mask code).
* Consider parser combinators / grammar-driven parsing where appropriate.

== Quick Wins

- Add `warp dump simd --lang ruby|--lang crystal` to expose SIMD indices early.
- Document alignment configuration for SIMD backends (mode/bytes) and add CI checks.
- Keep ARMv6 backend maintenance (compatibility note) while focusing on NEON/AVX performance.

== Next Actions

1. Add a CI benchmark harness for SIMD vs scalar with repeatable CSV output.
2. Expand scanner micro-benchmarks to cover state-aware helpers and string/regex paths.
3. Implement `dump simd` CLI wiring and integration tests for Ruby/Crystal.

== Contacts & Owners

* Proposed owner: @werner (engineering lead)
* Contributors: SIMD, Lexer, Parser teams

== References

* papers/implementation/2026-02-06-01_simd_ruby_crystal_implementation.adoc
* papers/implementation/2026-02-03-01_enhanced_simd_scan.adoc
* README.md (SIMD / Stage1a notes)


// End of document
