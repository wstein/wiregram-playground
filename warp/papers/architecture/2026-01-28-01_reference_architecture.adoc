= Reference Architecture

// tag::pipeline[]
== SIMD-Accelerated Lexing & Parsing

Warp follows a lexer + IR parsing pipeline optimized for performance while maintaining zero-copy semantics.

=== Stage 1a: SIMD Scan (Structural Scanning)

**Purpose**: Identifies structural JSON characters and validates UTF-8/escapes.

**Key Features**:
* Scans input bytes to locate structural characters (`{`, `}`, `[`, `]`, `:`, `,`)
* Performs UTF-8 validation and escape sequence detection
* Produces structural indices (positions of all structural tokens)
* Uses SIMD acceleration (NEON on ARM64, AVX2 on x86) for maximum performance

**Output**: Array of byte positions pointing to structural tokens.

=== Stage 1b: Lexer Assembly

**Purpose**: Converts scan artifacts into a token stream with spans and trivia metadata.

**Key Features**:
* Converts structural indices into a token stream (strings, numbers, literals, separators)
* Attaches spans and trivia (whitespace/newlines)
* Prepares tokens for Stage 2 parsing

**Output**: Token stream with spans into original source.

=== Stage 2: Parser (Tape Building)

**Purpose**: Traditional parser that builds a structured representation.

**Key Features**:
* Consumes structural indices from Stage 1
* Builds a compact "tape" representation with typed entries
* Links containers (objects/arrays) with their contents
* Validates JSON syntax and structure

**Output**: Compact tape with typed entries.
// end::pipeline[]

// tag::scenarios[]
== Project Scenarios

Warp is designed for:
1. **Ruby-to-Crystal Transpilation**: Lossless conversion with formatting preservation.
2. **Crystal-to-Ruby Transpilation**: Including Sorbet-to-Ruby translation.
3. **High-Performance JSON Processing**: Using the SIMD backend directly.
// end::scenarios[]

== Component Architecture

[mermaid]
----
graph TB
    subgraph "Stage 1a: SIMD-Accelerated Scan"
        S1[Neon Module] --> S2[Scanner]
        S3[Utf8Validator] --> S2
        S4[EscapeScanner] --> S2
        S5[StringScanner] --> S2
        S2 --> S6[Scan Artifacts]
    end
----
